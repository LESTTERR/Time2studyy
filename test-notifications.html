<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f8f8;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <!-- Include notification manager script -->
    <script src="js/notification-manager.js" defer></script>
    <h1>Notification Test</h1>
    <p>This page tests the notification functionality for your PWA.</p>

    <div id="status">Loading notification manager...</div>

    <div id="controls" style="display: none;">
        <button id="requestPermission">Request Notification Permission</button>
        <button id="testClassReminder">Test Class Reminder</button>
        <button id="testTaskReminder">Test Task Reminder</button>
        <button id="checkStatus">Check Notification Status</button>
    </div>

    <div id="testData" style="display: none; margin-top: 20px;">
        <h3>Test Data</h3>
        <div>
            <label for="className">Class Name:</label>
            <input type="text" id="className" value="Math 101" placeholder="Class name">
        </div>
        <div>
            <label for="classTime">Class Time:</label>
            <input type="time" id="classTime" value="10:00">
        </div>
        <div>
            <label for="taskName">Task Name:</label>
            <input type="text" id="taskName" value="Homework Assignment" placeholder="Task name">
        </div>
    </div>

    <script>
        // Wait for the notification manager to be ready
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('status');
            const controls = document.getElementById('controls');

            // Check if notification manager is available
            function checkNotificationManager() {
                if (window.notificationManager) {
                    statusElement.textContent = 'Notification manager loaded successfully!';
                    statusElement.className = 'success';
                    controls.style.display = 'block';
                    document.getElementById('testData').style.display = 'block';
                    setupEventListeners();
                } else {
                    statusElement.textContent = 'Waiting for notification manager...';
                    setTimeout(checkNotificationManager, 500);
                }
            }

            function setupEventListeners() {
                document.getElementById('requestPermission').addEventListener('click', async function() {
                    try {
                        const result = await window.notificationManager.requestPermission();
                        if (result) {
                            statusElement.textContent = 'Notification permission granted!';
                            statusElement.className = 'success';
                        } else {
                            statusElement.textContent = 'Notification permission denied.';
                            statusElement.className = 'error';
                        }
                    } catch (error) {
                        statusElement.textContent = 'Error requesting permission: ' + error.message;
                        statusElement.className = 'error';
                    }
                });

                document.getElementById('testClassReminder').addEventListener('click', async function() {
                    const className = document.getElementById('className').value;
                    const classTime = document.getElementById('classTime').value;

                    try {
                        // Create a test class item
                        const testClass = {
                            id: 'test-class-' + Date.now(),
                            name: className,
                            startTime: classTime,
                            days: [new Date().toLocaleDateString('en-US', { weekday: 'long' })]
                        };

                        // Calculate reminder time (5 minutes from now)
                        const now = new Date();
                        const reminderTime = new Date(now.getTime() + (5 * 60 * 1000));

                        // Create reminder object
                        const reminder = {
                            type: 'class',
                            data: testClass,
                            reminderTime: reminderTime,
                            intervalType: '5min'
                        };

                        // Schedule the reminder
                        await window.notificationManager.scheduleReminder(reminder);

                        statusElement.textContent = `Test class reminder scheduled for ${reminderTime.toLocaleTimeString()}`;
                        statusElement.className = 'success';

                        // Also show immediate notification for testing
                        if (window.notificationManager.isSafari) {
                            window.notificationManager.showSafariNotification('class', testClass, '5min');
                        }

                    } catch (error) {
                        statusElement.textContent = 'Error testing class reminder: ' + error.message;
                        statusElement.className = 'error';
                    }
                });

                document.getElementById('testTaskReminder').addEventListener('click', async function() {
                    const taskName = document.getElementById('taskName').value;

                    try {
                        // Create a test task item
                        const testTask = {
                            id: 'test-task-' + Date.now(),
                            name: taskName,
                            dueDate: new Date(Date.now() + (24 * 60 * 60 * 1000)) // Tomorrow
                        };

                        // Calculate reminder time (24 hours before due date)
                        const reminderTime = new Date(testTask.dueDate.getTime() - (24 * 60 * 60 * 1000));

                        // Create reminder object
                        const reminder = {
                            type: 'task',
                            data: testTask,
                            reminderTime: reminderTime
                        };

                        // Schedule the reminder
                        await window.notificationManager.scheduleReminder(reminder);

                        statusElement.textContent = `Test task reminder scheduled for ${reminderTime.toLocaleTimeString()}`;
                        statusElement.className = 'success';

                    } catch (error) {
                        statusElement.textContent = 'Error testing task reminder: ' + error.message;
                        statusElement.className = 'error';
                    }
                });

                document.getElementById('checkStatus').addEventListener('click', function() {
                    const status = window.notificationManager.getStatus();
                    statusElement.innerHTML = `
                        <strong>Notification Status:</strong><br>
                        Supported: ${status.supported}<br>
                        Permission: ${status.permission}<br>
                        Subscription: ${status.subscription}<br>
                        Service Worker: ${status.serviceWorker}<br>
                        Safari Mode: ${window.notificationManager.isSafari}
                    `;
                    statusElement.className = 'success';
                });
            }

            // Start checking for notification manager
            checkNotificationManager();
        });
    </script>
</body>
</html>