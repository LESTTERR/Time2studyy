<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="../js/manifest.json">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Study Planner – Tasks</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/tasks.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <div class="app-container" style="display:none;">
    <div class="content-section active" id="tasksSection">
      <div class="full-task-card">
        <div class="card-header">
          <h3><span class="material-icons">assignment</span> All Tasks</h3>
        </div>
        <div class="task-list" id="tasksList">
          <!-- Tasks will be loaded here from Firestore -->
        </div>
      </div>
    </div>
</div></div>
    <!-- Floating Add-Task Button -->
    <div class="fab-container">
      <button class="fab-main material-icons" id="addTaskFab">add</button>
    </div>


    <div id="chatbot-fab" style="display: none;">
  <span class="material-icons">smart_toy</span>
</div>

  <!-- Chatbot window: Hidden by default, shown when FAB clicked -->
  <div id="chatbot-window" style="display:none;">
    <!-- Chatbot header with title and close button -->
    <div id="chatbot-header">
      <span style="font-weight:600;font-size:1.1rem;">T2S Chatbot</span>
      <span id="chatbot-close" class="material-icons">close</span>
    </div>

    <!-- Chatbot message display area -->
    <div id="messages"></div>

    <!-- Chatbot input section: Text input + send button -->
    <div id="chatbot-input-section">
      <input id="userInput" type="text" placeholder="Type a message...">
      <button id="chatbot-send">
        <span class="material-icons">send</span>
      </button>
    </div>
  </div>
  
 <!-- ═══════════════════════════════════════════════════════════════ -->
  <!-- TAB NAVIGATION: injected from components/tabbar.html -->
  <!-- ═══════════════════════════════════════════════════════════════ -->
  <div id="tab-bar-container"></div>
  <script>
    (async function loadTabbar() {
      try {
        const res = await fetch('./components/tabsbar.html');
        const html = await res.text();
        const container = document.getElementById('tab-bar-container');
        container.innerHTML = html;

        // Execute any scripts included in the fetched fragment
        container.querySelectorAll('script').forEach(s => {
          const ns = document.createElement('script');
          if (s.src) ns.src = s.src; else ns.textContent = s.textContent;
          document.body.appendChild(ns);
          s.remove();
        });

        // Show the bar (fragment default is display:none)
        const bar = container.querySelector('.tab-bar');
        if (bar) bar.style.display = 'flex';

        // Mark the current page tab active (by href or data-target)
        const path = location.pathname.split('/').pop();
        container.querySelectorAll('.tab-item').forEach(item => {
          // compare href filename or data-target match
          const href = item.getAttribute('href') || '';
          const target = item.dataset.target || '';
          if (href.endsWith(path) || (target && document.getElementById(target))) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });

      } catch (err) {
        console.error('Failed to load tab bar:', err);
      }
    })();
  </script>
  


<!-- ✅ Firebase and Firestore -->
<script type="module">
  import { db, auth } from '../js/firebase-init.js';
  import {
    collection,
    deleteDoc,
    doc,
    query,
    where,
    orderBy,
    onSnapshot,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const tasksList = document.getElementById("tasksList");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    // Show loader, hide app
    document.getElementById('tasksLoading').style.display = 'flex';
    document.querySelector('.app-container').style.display = 'none';

    const displayTasks = (tasks) => {
      tasksList.innerHTML = "";

      if (!tasks.length) {
        tasksList.innerHTML = "<p style='text-align:center;color:gray;'>No tasks found. Start by adding one!</p>";
        return;
      }

      tasks.forEach(task => {
        const dueDate = new Date(task.dueDate);
        const options = {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        };

       const div = document.createElement("div");
div.className = `task-item ${task.type || ''}` + (task.completed ? " done" : "");

       
         div.innerHTML = `
  <div class="task-info">
       <p style="font-size: 1.5em; font-weight: bold;
 color: ${task.type === 'Assignment' ? 'green' : task.type === 'Project' ? 'red' : 'black'};">
      <strong>${task.type}</strong></p><h4>${task.name}</h4>
    <p>${task.description}</p>
   
    <span class="deadline">Deadline: ${dueDate.toLocaleDateString('en-US', options)}</span>
  </div>
  <div class="task-actions">
    <button class="done-btn" ${task.completed ? "disabled" : ""}>${task.completed ? "Done!" : "Done"}</button>
    <button class="delete-btn" data-id="${task.id}">
      <span class="material-icons">delete</span>
    </button>
  </div>
`;

        tasksList.appendChild(div);
      });

      document.querySelectorAll(".done-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const taskItem = btn.closest(".task-item");
          const id = taskItem.querySelector(".delete-btn").getAttribute("data-id");
          try {
            await updateDoc(doc(db, "tasks", id), { completed: true });
            // Optionally, visually mark as done immediately:
            taskItem.classList.add("done");
            btn.disabled = true;
            btn.textContent = "Done!";
          } catch (error) {
            alert("Failed to mark as done. Please try again.");
          }
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Are you sure you want to delete this task?")) return;
          try {
            await deleteDoc(doc(db, "tasks", id));
            btn.closest(".task-item").remove();

            const cached = localStorage.getItem("tasks");
            if (cached) {
              const updated = JSON.parse(cached).filter(t => t.id !== id);
              localStorage.setItem("tasks", JSON.stringify(updated));
            }

            if (!tasksList.children.length) {
              tasksList.innerHTML = "<p style='text-align:center;color:gray;'>No tasks found. Start by adding one!</p>";
            }

          } catch (error) {
            console.error("Delete failed:", error);
            alert("Failed to delete task. Please try again.");
          }
        });
      });
    };

    const cached = localStorage.getItem("tasks");
    if (cached) {
      try {
        displayTasks(JSON.parse(cached));
      } catch (e) {
        console.warn("Invalid cache");
      }
    }

    const q = query(
      collection(db, "tasks"),
      where("userId", "==", user.uid),
      orderBy("dueDate")
    );

    onSnapshot(q, (snapshot) => {
      const tasks = snapshot.docs.map(docSnap => ({
        ...docSnap.data(),
        id: docSnap.id
      }));
      displayTasks(tasks);
      localStorage.setItem("tasks", JSON.stringify(tasks));

      // Hide loader, show app after first fetch
      document.getElementById('tasksLoading').style.display = 'none';
      document.querySelector('.app-container').style.display = 'block';
    });

    document.getElementById("addTaskFab").addEventListener("click", () => {
      window.location.href = "add-task.html";
    });
  });
</script>


<script>
const fab = document.getElementById('chatbot-fab');
const chatWindow = document.getElementById('chatbot-window');
const closeBtn = document.getElementById('chatbot-close');
const sendBtn = document.getElementById('chatbot-send');
const input = document.getElementById('userInput');
const messages = document.getElementById('messages');

// Show chat window when FAB is clicked
fab.onclick = () => {
  chatWindow.style.display = 'flex';
  fab.style.display = 'none';
  input.focus();
};

// Hide chat window when close is clicked
closeBtn.onclick = () => {
  chatWindow.style.display = 'none';
  fab.style.display = 'flex';
};

// Send message on button click or Enter key
sendBtn.onclick = sendMessage;
input.addEventListener('keydown', e => {
  if (e.key === 'Enter') sendMessage();
});

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage('user', text);
  input.value = '';
  input.disabled = true;
  sendBtn.disabled = true;
  await sendMessageToDialogflow(text);
  input.disabled = false;
  sendBtn.disabled = false;
  input.focus();
}

async function sendMessageToDialogflow(message, sessionId = 'user-123') {
  addMessage('bot', '...');
  try {
    const response = await fetch('https://frontendapichatbot.vercel.app/api/dialogflow', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, sessionId })
    });
    const data = await response.json();
    // Remove the loading "..." message
    messages.removeChild(messages.lastChild);
    addMessage('bot', data.reply || 'Sorry, no reply.');
  } catch (err) {
    messages.removeChild(messages.lastChild);
    addMessage('bot', 'Error connecting to server.');
  }
}

function addMessage(sender, text) {
  const msg = document.createElement('div');
  msg.className = sender;
  msg.textContent = text;
  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;
}
</script>

<div id="tasksLoading" style="display:flex;align-items:center;justify-content:center;height:100vh;">
  <span style="color:#2196F3;font-size:1.2rem;font-weight:500;">loading tasks...</span>
</div>

</body>
</html>



