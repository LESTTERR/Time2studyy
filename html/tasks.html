<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="../js/manifest.json">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Study Planner â€“ Tasks</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/tasks.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  
</head>
<body>
 
  <!-- LOADING SCREEN: Shown on app startup (before authentication) -->
<div id="loadingScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;justify-content:center;align-items:center;z-index:9999;">
  <!-- Loader will be injected here -->
</div>

  <div class="app-container" style="display:none;">
    <div class="content-section active" id="tasksSection">
      <div class="full-task-card">
        <div class="card-header">
          <h3><span class="material-icons">assignment</span> All Tasks</h3>
        </div>
        <div class="task-list" id="tasksList">
          <!-- Tasks will be loaded here from Firestore -->
        </div>
      </div>
    </div>
  </div> <!-- Fixed extra closing div -->

  <!-- Floating Add-Task Button -->
  <div class="fab-container">
    <button class="fab-main material-icons" id="addTaskFab">add</button>
  </div>

  <div id="chatbot-fab" style="display: none;">
    <span class="material-icons">smart_toy</span>
  </div>

  <!-- Chatbot window: Hidden by default, shown when FAB clicked -->
  <div id="chatbot-window" style="display:none;">
    <div id="chatbot-header">
      <span style="font-weight:600;font-size:1.1rem;">T2S Chatbot</span>
      <span id="chatbot-close" class="material-icons">close</span>
    </div>
    <div id="messages"></div>
    <div id="chatbot-input-section">
      <input id="userInput" type="text" placeholder="Type a message...">
      <button id="chatbot-send">
        <span class="material-icons">send</span>
      </button>
    </div>
  </div>
  
  <!-- TAB NAVIGATION: injected from components/tabbar.html -->
  <div id="tab-bar-container"></div>

<script>
  // Load tabbar and handle errors
  (async function loadTabbar() {
    try {
      const res = await fetch('./components/tabsbar.html');
      if (!res.ok) throw new Error('Tabbar not found');
      const html = await res.text();
      const container = document.getElementById('tab-bar-container');
      container.innerHTML = html;

      // Execute any scripts included in the fetched fragment
      container.querySelectorAll('script').forEach(s => {
        const ns = document.createElement('script');
        if (s.src) ns.src = s.src; else ns.textContent = s.textContent;
        document.body.appendChild(ns);
        s.remove();
      });
    } catch (err) {
      console.error('Failed to load tab bar:', err);
      // Continue without tabbar - don't block the app
    }
  })();
</script>

<!-- Firebase and Firestore -->
<script type="module">
  import { db, auth } from '../js/firebase-init.js';
  import {
    collection,
    deleteDoc,
    doc,
    query,
    where,
    orderBy,
    onSnapshot,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const tasksList = document.getElementById("tasksList");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    // Show loader, hide app - FIXED: Use correct ID 'loadingScreen'
    const loadingScreen = document.getElementById('loadingScreen');
    const appContainer = document.querySelector('.app-container');
    if (loadingScreen) loadingScreen.style.display = 'flex';
    if (appContainer) appContainer.style.display = 'none';

    const displayTasks = (tasks) => {
      tasksList.innerHTML = "";

      if (!tasks.length) {
        tasksList.innerHTML = "<p style='text-align:center;color:gray;'>No tasks found. Start by adding one!</p>";
        return;
      }

      tasks.forEach(task => {
        const dueDate = new Date(task.dueDate);
        const options = {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        };

        const div = document.createElement("div");
        div.className = `task-item ${task.type || ''}` + (task.completed ? " done" : "");

        div.innerHTML = `
          <div class="task-info">
            <p style="font-size: 1.5em; font-weight: bold; color: ${task.type === 'Assignment' ? 'green' : task.type === 'Project' ? 'red' : 'black'};">
              <strong>${task.type}</strong>
            </p>
            <h4>${task.name}</h4>
            <p>${task.description}</p>
            <span class="deadline">Deadline: ${dueDate.toLocaleDateString('en-US', options)}</span>
          </div>
          <div class="task-actions">
            <button class="done-btn" ${task.completed ? "disabled" : ""}>${task.completed ? "Done!" : "Done"}</button>
            <button class="delete-btn" data-id="${task.id}">
              <span class="material-icons">delete</span>
            </button>
          </div>
        `;

        tasksList.appendChild(div);
      });

      // Add event listeners for buttons
      document.querySelectorAll(".done-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const taskItem = btn.closest(".task-item");
          const id = taskItem.querySelector(".delete-btn").getAttribute("data-id");
          try {
            await updateDoc(doc(db, "tasks", id), { completed: true });
            taskItem.classList.add("done");
            btn.disabled = true;
            btn.textContent = "Done!";
          } catch (error) {
            alert("Failed to mark as done. Please try again.");
          }
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Are you sure you want to delete this task?")) return;
          try {
            await deleteDoc(doc(db, "tasks", id));
            btn.closest(".task-item").remove();

            const cached = localStorage.getItem("tasks");
            if (cached) {
              const updated = JSON.parse(cached).filter(t => t.id !== id);
              localStorage.setItem("tasks", JSON.stringify(updated));
            }

            if (!tasksList.children.length) {
              tasksList.innerHTML = "<p style='text-align:center;color:gray;'>No tasks found. Start by adding one!</p>";
            }
          } catch (error) {
            console.error("Delete failed:", error);
            alert("Failed to delete task. Please try again.");
          }
        });
      });
    };

    // Try to load from cache first
    const cached = localStorage.getItem("tasks");
    if (cached) {
      try {
        displayTasks(JSON.parse(cached));
      } catch (e) {
        console.warn("Invalid cache");
      }
    }

    // Set up real-time listener
    const q = query(
      collection(db, "tasks"),
      where("userId", "==", user.uid),
      orderBy("dueDate")
    );

    onSnapshot(q, (snapshot) => {
      const tasks = snapshot.docs.map(docSnap => ({
        ...docSnap.data(),
        id: docSnap.id
      }));
      displayTasks(tasks);
      localStorage.setItem("tasks", JSON.stringify(tasks));

      // Hide loader, show app after first fetch - FIXED: Use correct ID
      const loadingScreen = document.getElementById('loadingScreen');
      const appContainer = document.querySelector('.app-container');
      if (loadingScreen) loadingScreen.style.display = 'none';
      if (appContainer) appContainer.style.display = 'block';

      // Show tab bar and chatbot FAB
      const tabBar = document.querySelector('.tab-bar');
      if (tabBar) tabBar.style.display = 'flex';
      const chatbotFab = document.getElementById('chatbot-fab');
      if (chatbotFab) chatbotFab.style.display = 'flex';
    }, (error) => {
      console.error("Error loading tasks:", error);
      // Even on error, hide loading screen to avoid getting stuck
      const loadingScreen = document.getElementById('loadingScreen');
      const appContainer = document.querySelector('.app-container');
      if (loadingScreen) loadingScreen.style.display = 'none';
      if (appContainer) appContainer.style.display = 'block';
    });

    document.getElementById("addTaskFab").addEventListener("click", () => {
      window.location.href = "add-task.html";
    });
  });



    (async function loadLoader() {
    try {
      const res = await fetch('./components/loader.html');
      const html = await res.text();
      const container = document.getElementById('loadingScreen');
      container.innerHTML = html;
    } catch (err) {
      console.error('Failed to load loader:', err);
    }
  })();
</script>

<script src="../js/chatbot.js"></script>

</body>
</html>